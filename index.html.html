import React, { useState, useEffect, useRef } from 'react';
import * as Tone from 'tone'; // Import Tone.js

function App() {
  const [currentPage, setCurrentPage] = useState('learning'); // 預設顯示學習頁

  // 初始化音訊上下文的函數
  const initializeAudioContext = async () => {
    // 確保音訊上下文尚未啟動，避免重複啟動
    if (Tone.context.state !== 'running') {
      await Tone.start();
      console.log('AudioContext is initialized and running!'); // 確認訊息
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-pink-100 to-blue-100 flex flex-col items-center justify-center p-4 font-inter">
      {/* 導覽列 */}
      <nav className="mb-8 p-4 bg-white rounded-2xl shadow-lg flex flex-wrap justify-center gap-4">
        <button
          onClick={() => {
            initializeAudioContext(); // 在點擊導覽按鈕時初始化音訊
            setCurrentPage('learning');
          }}
          className={`px-6 py-3 rounded-full text-lg font-bold transition-all duration-300 transform hover:scale-105
            ${currentPage === 'learning' ? 'bg-purple-500 text-white shadow-md' : 'bg-purple-200 text-purple-800 hover:bg-purple-300'}`}
        >
          📚 學習乘法
        </button>
        <button
          onClick={() => {
            initializeAudioContext(); // 在點擊導覽按鈕時初始化音訊
            setCurrentPage('practice');
          }}
          className={`px-6 py-3 rounded-full text-lg font-bold transition-all duration-300 transform hover:scale-105
            ${currentPage === 'practice' ? 'bg-green-500 text-white shadow-md' : 'bg-green-200 text-green-800 hover:bg-green-300'}`}
        >
          📝 練習挑戰
        </button>
      </nav>

      {/* 根據 currentPage 顯示不同頁面 */}
      <main className="w-full max-w-4xl bg-white rounded-3xl shadow-xl p-6 md:p-8 transform transition-transform duration-500 ease-out">
        {currentPage === 'learning' ? <LearningPage /> : <PracticePage />}
      </main>
    </div>
  );
}

function LearningPage() {
  const [hoveredRow, setHoveredRow] = useState(null); // 追蹤滑鼠所在的行
  const [hoveredCol, setHoveredCol] = useState(null); // 追蹤滑鼠所在的列

  // 處理滑鼠進入儲存格
  const handleCellEnter = (row, col) => {
    setHoveredRow(row);
    setHoveredCol(col);
  };

  // 處理滑鼠離開儲存格
  const handleCellLeave = () => {
    setHoveredRow(null);
    setHoveredCol(null);
  };

  return (
    <div className="text-center">
      <h1 className="text-4xl md:text-5xl font-extrabold text-blue-600 mb-8 drop-shadow-md">
        十十乘法表 💖
      </h1>
      <div className="overflow-x-auto">
        <table className="min-w-full bg-blue-50 border border-blue-200 rounded-xl shadow-lg">
          <thead>
            <tr className="bg-blue-200 text-blue-800">
              <th className="py-3 px-2 md:px-4 border-b border-blue-200 text-lg md:text-xl font-bold rounded-tl-xl">×</th>
              {Array.from({ length: 10 }, (_, i) => i + 1).map((num) => (
                <th
                  key={num}
                  className={`py-3 px-2 md:px-4 border-b border-blue-200 text-lg md:text-xl font-bold
                    ${hoveredCol === num ? 'bg-yellow-300' : ''}`} // 標題列的顏色反應
                >
                  {num}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {Array.from({ length: 10 }, (_, i) => i + 1).map((rowNum) => (
              <tr key={rowNum} className="transition-colors duration-200">
                <td
                  className={`py-3 px-2 md:px-4 border-b border-blue-200 text-blue-700 font-bold bg-blue-100 rounded-bl-xl text-lg md:text-xl
                    ${hoveredRow === rowNum ? 'bg-yellow-300' : ''}`} // 標題行的顏色反應
                >
                  {rowNum}
                </td>
                {Array.from({ length: 10 }, (_, i) => i + 1).map((colNum) => (
                  <td
                    key={`${rowNum}-${colNum}`}
                    onMouseEnter={() => handleCellEnter(rowNum, colNum)}
                    onMouseLeave={handleCellLeave}
                    className={`py-3 px-2 md:px-4 border-b border-blue-200 text-gray-700 text-lg md:text-xl
                      ${(hoveredRow === rowNum || hoveredCol === colNum) ? 'bg-yellow-100' : ''}`} // 儲存格本身的顏色反應
                  >
                    {rowNum * colNum}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      <p className="mt-8 text-gray-600 text-lg">
        這個表格可以幫助你快速學習乘法！
      </p>
    </div>
  );
}

function PracticePage() {
  const [selectedMultiplier, setSelectedMultiplier] = useState(null); // 選擇的乘數，可以是數字或 'all'
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0); // 當前題目索引 (0-9)
  const [currentQuestion, setCurrentQuestion] = useState(null); // 當前題目 { factor1, factor2, answer }
  const [options, setOptions] = useState([]); // 答案選項
  const [score, setScore] = useState(0); // 分數
  const [roundStarted, setRoundStarted] = useState(false); // 回合是否開始
  const [feedbackMessage, setFeedbackMessage] = useState(''); // 回饋訊息
  const [showResult, setShowResult] = useState(false); // 顯示結果頁面
  const [selectedAnswer, setSelectedAnswer] = useState(null); // 用戶選擇的答案
  const [isCorrectAnswer, setIsCorrectAnswer] = useState(null); // 用於答案按鈕的視覺回饋
  const [questionHistory, setQuestionHistory] = useState([]); // 新增：儲存所有題目歷史

  // Tone.js 音效合成器
  const synthRef = useRef(null);

  useEffect(() => {
    // 初始化 Tone.js 合成器
    synthRef.current = new Tone.Synth().toDestination();
    // 這裡不再呼叫 Tone.start()，因為它會在導覽按鈕點擊時啟動
    return () => {
      // 在組件卸載時釋放音效資源
      if (synthRef.current) {
        synthRef.current.dispose();
      }
    };
  }, []);

  // 幫助函式：延遲一段時間
  const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

  // 播放正確音效 (叮咚叮咚)
  const playCorrectSound = async () => {
    if (synthRef.current && Tone.context.state === 'running') { // 確保音訊上下文已啟動
      synthRef.current.triggerAttackRelease("C5", "8n"); // 第一個叮
      await delay(100); // 0.1秒間隔
      synthRef.current.triggerAttackRelease("G5", "8n"); // 第一個咚
      await delay(200); // 0.2秒間隔 (兩組叮咚之間)
      synthRef.current.triggerAttackRelease("C5", "8n"); // 第二個叮
      await delay(100); // 0.1秒間隔
      synthRef.current.triggerAttackRelease("G5", "8n"); // 第二個咚
    }
  };

  // 播放錯誤音效 (噠噠)
  const playIncorrectSound = async () => {
    if (synthRef.current && Tone.context.state === 'running') { // 確保音訊上下文已啟動
      synthRef.current.triggerAttackRelease("F4", "8n");
      await delay(250); // 模擬8n的延遲
      synthRef.current.triggerAttackRelease("C4", "8n");
    }
  };

  // 生成新的問題和選項
  const generateQuestion = (multiplier) => {
    let factor1, factor2;

    if (multiplier === 'all') {
      // 綜合練習，兩個乘數都是隨機 1 到 10
      factor1 = Math.floor(Math.random() * 10) + 1;
      factor2 = Math.floor(Math.random() * 10) + 1;
    } else {
      // 特定乘數練習
      factor1 = multiplier;
      factor2 = Math.floor(Math.random() * 10) + 1; // 1 到 10
    }

    const answer = factor1 * factor2;

    const newOptions = new Set();
    newOptions.add(answer); // 添加正確答案

    // 生成三個錯誤選項
    while (newOptions.size < 4) {
      let wrongAnswer = answer + (Math.floor(Math.random() * 20) - 10); // 在答案附近生成
      // 確保答案不為負或零，且與正確答案不同
      if (wrongAnswer <= 0 || wrongAnswer === answer) {
        continue;
      }
      newOptions.add(wrongAnswer);
    }

    const shuffledOptions = Array.from(newOptions).sort(() => Math.random() - 0.5);

    setCurrentQuestion({ factor1: factor1, factor2: factor2, answer: answer });
    setOptions(shuffledOptions);
    setSelectedAnswer(null); // 重置選擇的答案
    setIsCorrectAnswer(null); // 重置答案回饋
    setFeedbackMessage(''); // 清空回饋訊息
  };

  // 處理用戶選擇答案
  const handleAnswer = (selectedOption) => {
    if (selectedAnswer !== null) return; // 避免重複點擊

    setSelectedAnswer(selectedOption); // 設置用戶選擇的答案
    const correct = selectedOption === currentQuestion.answer;
    setIsCorrectAnswer(correct); // 設置正確性回饋

    if (correct) {
      setScore((prevScore) => prevScore + 10);
      setFeedbackMessage('✅ 答對了！');
      playCorrectSound();
    } else {
      setFeedbackMessage(`❌ 答錯了，正確答案是 ${currentQuestion.answer}`);
      playIncorrectSound();
    }

    // 儲存當前題目的歷史記錄
    setQuestionHistory((prevHistory) => [
      ...prevHistory,
      {
        question: `${currentQuestion.factor1} × ${currentQuestion.factor2}`,
        correctAnswer: currentQuestion.answer,
        userAnswer: selectedOption,
        isCorrect: correct,
      },
    ]);

    // 等待一小段時間後進入下一題或顯示結果
    setTimeout(() => {
      if (currentQuestionIndex < 9) {
        setCurrentQuestionIndex((prevIndex) => prevIndex + 1);
        generateQuestion(selectedMultiplier);
      } else {
        setShowResult(true);
      }
    }, 1500); // 1.5 秒後
  };

  // 開始一輪練習
  const startRound = () => {
    setScore(0);
    setCurrentQuestionIndex(0);
    setRoundStarted(true);
    setShowResult(false);
    setQuestionHistory([]); // 重置題目歷史
    generateQuestion(selectedMultiplier);
  };

  // 重新開始練習
  const restartPractice = () => {
    setSelectedMultiplier(null);
    setRoundStarted(false);
    setShowResult(false);
    setFeedbackMessage('');
    setQuestionHistory([]); // 重置題目歷史
  };

  // 渲染選擇乘數的介面
  if (!roundStarted) {
    return (
      <div className="text-center p-4">
        <h1 className="text-4xl md:text-5xl font-extrabold text-green-600 mb-8 drop-shadow-md">
          乘法大挑戰 🌟
        </h1>
        <p className="text-xl text-gray-700 mb-6">
          進入【綜合練習】進行挑戰，或選擇你想練習的數字段哦！
        </p>
        <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4 max-w-2xl mx-auto mb-8">
          {/* 綜合練習按鈕移到最前面並置中 */}
          <button
            onClick={() => setSelectedMultiplier('all')}
            className={`col-span-full p-4 rounded-xl text-2xl font-bold transition-all duration-300 transform hover:scale-110 shadow-md mb-4
              ${selectedMultiplier === 'all' ? 'bg-indigo-500 text-white ring-4 ring-indigo-300' : 'bg-indigo-200 text-indigo-800 hover:bg-indigo-300'}`}
          >
            🎲 綜合練習 (1~10)
          </button>
          {Array.from({ length: 10 }, (_, i) => i + 1).map((num) => (
            <button
              key={num}
              onClick={() => setSelectedMultiplier(num)}
              className={`p-4 rounded-xl text-2xl font-bold transition-all duration-300 transform hover:scale-110 shadow-md
                ${selectedMultiplier === num ? 'bg-orange-500 text-white ring-4 ring-orange-300' : 'bg-orange-200 text-orange-800 hover:bg-orange-300'}`}
            >
              {num}
            </button>
          ))}
        </div>
        <button
          onClick={startRound}
          disabled={selectedMultiplier === null}
          className={`px-8 py-4 rounded-full text-2xl font-bold transition-all duration-300 transform hover:scale-105 shadow-lg
            ${selectedMultiplier === null ? 'bg-gray-300 text-gray-600 cursor-not-allowed' : 'bg-blue-500 text-white hover:bg-blue-600'}`}
        >
          開始練習！🚀
        </button>
      </div>
    );
  }

  // 渲染練習介面
  if (roundStarted && !showResult) {
    // 根據選擇的乘數顯示不同的標題
    const practiceTitle = selectedMultiplier === 'all'
      ? '綜合乘法練習 ✨'
      : `乘法練習：${selectedMultiplier} 的乘法表 ✨`;

    return (
      <div className="text-center p-4">
        <h1 className="text-4xl md:text-5xl font-extrabold text-purple-600 mb-6 drop-shadow-md">
          {practiceTitle}
        </h1>
        <div className="text-2xl md:text-3xl font-bold text-gray-700 mb-4">
          得分: <span className="text-green-600">{score}</span> / 100
        </div>
        <div className="text-xl md:text-2xl text-gray-600 mb-8">
          題目 {currentQuestionIndex + 1} / 10
        </div>

        {currentQuestion && (
          <div className="bg-yellow-100 p-6 rounded-3xl shadow-xl inline-block mb-8 transition-transform duration-300 transform scale-105">
            <p className="text-5xl md:text-6xl font-extrabold text-yellow-800">
              {currentQuestion.factor1} × {currentQuestion.factor2} = ?
            </p>
          </div>
        )}

        <div className="grid grid-cols-2 gap-4 max-w-md mx-auto mb-6">
          {options.map((option) => (
            <button
              key={option}
              onClick={() => handleAnswer(option)}
              disabled={selectedAnswer !== null} // 禁用按鈕直到下一題
              className={`p-4 rounded-2xl text-3xl font-bold transition-all duration-300 transform hover:scale-105 shadow-md
                ${selectedAnswer === null
                  ? 'bg-indigo-300 text-indigo-900 hover:bg-indigo-400' // 未選擇時
                  : option === currentQuestion.answer
                    ? 'bg-green-500 text-white scale-110 shadow-lg' // 正確答案
                    : (selectedAnswer === option && !isCorrectAnswer)
                      ? 'bg-red-500 text-white scale-105 shadow-lg' // 錯誤答案
                      : 'bg-indigo-300 text-indigo-900 opacity-50 cursor-not-allowed' // 其他未選擇的答案
                }`}
            >
              {option}
            </button>
          ))}
        </div>

        {feedbackMessage && (
          <p className="text-2xl md:text-3xl font-bold mt-4 animate-bounce">
            {feedbackMessage}
          </p>
        )}
      </div>
    );
  }

  // 渲染結果頁面
  if (showResult) {
    return (
      <div className="text-center p-4">
        <h1 className="text-4xl md:text-5xl font-extrabold text-teal-600 mb-8 drop-shadow-md">
          練習結束！🎉
        </h1>
        <p className="text-3xl md:text-4xl font-bold text-gray-800 mb-4">
          你的最終得分是：
        </p>
        <p className="text-5xl md:text-6xl font-extrabold text-teal-600 bg-teal-50 p-6 rounded-full inline-block shadow-lg animate-bounce">
          {score} 分
        </p>

        {/* 新增：顯示題目和答案回顧 */}
        <h2 className="text-3xl font-bold text-blue-600 mt-10 mb-6 drop-shadow-md">
          題目回顧
        </h2>
        <div className="bg-white rounded-xl shadow-lg p-4 md:p-6 overflow-x-auto mx-auto max-w-xl">
          <table className="min-w-full text-left text-lg">
            <thead>
              <tr className="bg-blue-100 text-blue-800">
                <th className="py-2 px-3 border-b border-blue-200">題目</th>
                <th className="py-2 px-3 border-b border-blue-200">你的答案</th>
                <th className="py-2 px-3 border-b border-blue-200">正確答案</th>
              </tr>
            </thead>
            <tbody>
              {questionHistory.map((item, index) => (
                <tr key={index} className="border-b border-blue-50 last:border-b-0 hover:bg-blue-50 transition-colors duration-200">
                  <td className="py-2 px-3 font-bold">{item.question}</td> {/* 題目加粗 */}
                  <td className={`py-2 px-3 font-semibold ${item.isCorrect ? 'text-green-600' : 'text-red-500'}`}>
                    {item.userAnswer}
                  </td>
                  <td className="py-2 px-3 font-bold text-gray-700"> {/* 正確答案加粗 */}
                    {item.correctAnswer}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        <div className="mt-8 flex flex-col md:flex-row justify-center gap-4">
          <button
            onClick={restartPractice}
            className="px-8 py-4 rounded-full text-2xl font-bold bg-orange-500 text-white hover:bg-orange-600 transition-all duration-300 transform hover:scale-105 shadow-lg"
          >
            重新選擇練習 🔄
          </button>
          <button
            onClick={startRound}
            className="px-8 py-4 rounded-full text-2xl font-bold bg-purple-500 text-white hover:bg-purple-600 transition-all duration-300 transform hover:scale-105 shadow-lg"
          >
            {selectedMultiplier === 'all' ? '再玩一次綜合練習！🎲' : `再玩一次 ${selectedMultiplier} 的乘法！✨`}
          </button>
        </div>
      </div>
    );
  }
}

export default App;
